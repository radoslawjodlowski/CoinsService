# CoinsService

## Description
This project is presenting a way of connecting database application with cryptocurrency network and allowing to make withdraw and receive payment. The most important goal is to ensure transactionality.

### Technological stack
MSSQL, Java, Bitcoin RPC protocol

## Assumptions:
*   Enabling making withdraw, receiving payments and generating incoming addresses for users.
*   Full transactivity.
*   Resistance to failures.
*   Support for the wallets based on bitcoin JSON-RPC API protocol.
*   Configuration stored in the database.

# How it works ?
During initialization, the configuration is load from database. For each cryptocurrency is created separate object of `Wallet` and `CryptoCore` instance. While the instance of `SqlApi` is common for all object.

*   `SqlApi` - my simple mini framework for runing sql stored procedures
*   `Wallet` - class that executing operations on core wallet by JSON RPC
*   `CryptoCore` - class that is responsible for buisness logic

Then periodic scheduler run method `tryDoTasks` on `CryptoCore` for each cryptocurrency. This method executing list of tasks:

*   checkimg wallet state
*   generating new addresses
*   scanning for new incoming transactions
*   tracking input transactions
*   broadcasting signed outgoing transaction
*   making common outgoing withdraws
*   tracking output transactions

Order of list of `tasks` is so chosen to provide transactivity.

1. Each task can throw an exception, which breaks executing tasks list and executing of tasks can start again from first task.
2. Receiving payments based on scanning new generated block in search of new transactions and adding them to database. Repetition of scan block function wont't make a data mismatch, because `list of pending transaction` in database don't accept the second addition, as add balance to user is being executed in `runHotTransactions` procedure, which has database transactivity.
3. Sending withdrawals is realized in two steps. First, payment is generated by wallet, signed and stored to database. Next, payment is downloaded from database, broadcasted to network and committed to database. To ensure transactionality, the second step is performed first. The network does not allow the double spent of money.
4. Only method for generating new addresses, may generate address which will not be assigned to user (only in case of an error), but in the next run it will again generate a new address for the user.

# SQL API Documentation

### Configuration and generating addresses
| Method         | Description  |
| -------------- | ------------ |
| getCryptoConfig | Get a configuration informations, like `currency name`, `wallet IP`,` port`,` password`,` confirmations`,` account filter`      |
| getCryptoCoreData | Get a simple information about cryptocurenties, like `name`, `last processed block number & hash`, `fee`, `confitmations` |
| setBlockPoint |  Set number of last processed block|
| fillEmptyInputAddress | Set `input address` for the user |
| getEmptyAddresses | Return a list of `user id` who need have a `input address`|

### Receiving payments
| Method         | Description  |
| -------------- | ------------ |
| addHotInputTransaction | Adds new transaction to pending transactions list. Adding a second time this same transaction will be ommited. | 
| updateHotInputTransaction | Updates number of confirmations for new transaction on pending transactions list. |
| runHotTransactions | Runs a database stored procedure which moves balances from new incoming transactions to users and removes them from pending transactions list. This metod is run when in last update, count of confirmations is sufficient. |
| getTrackingInputTransactions | Returns list of pending incoming transactions for tracking their number of confirmations. |

### Making withdrawals

| Method         | Description  |
| -------------- | ------------ |
| getOutputTransactionsToCommit | Returns a list output withdraws for make common payment. The transactionability of this element is on the database side. |
| addSignedTransaction | Adds to database signed transaction (hex encoded).  |
| getSignedTransactions | Gets a signed transactions (hex encoded) to spend. |
| commitSentTransactionStatus | Sets in db that this transaction has been spet to network. Adds transaction to output temporary list for tracking. |
| getTrackingOutputTransactions | Gets list of output transactions which are on temporary list and don't have yet required number of confirmations. |
| updateHotOutputTransaction | Sets a number of confirmations for output transaction. If the number of confirmations is equal to the required number, this transaction is removed from temporary track list. |

# Wallet API Documentation

### Configuration and addresses
| Method         | Description  |
| -------------- | ------------ |
| getNewAddressByAccount | Generates a new address and sign it to name of account(filter). |
| getBlockNumber | Returns number o block by hash as input parameter. |
| getNetworkInfo | Runs `getnetworkinfo` command on wallet, and return data. | 

### Payments and withdraws
| Method         | Description  |
| -------------- | ------------ |
| getTxSinceBlock | Returns list of input transactions since block is given as parameter. |
| getConfirmationsNumber | Returns confirmation number for transaction given as `TxId`. |
| sendRawTransaction | Broadcasts a output transaction given as hex to network. |
| makeCommonPaymentsTransaction | This is the most complicated method. This method receives as parameter list of payments to spend and network fee. The method retrieves the list unspent element and make new transaction, signs it and returns new transaction as hex encoded string. |

# Tasks - documentation

### Check state and generating new addresses
| Method         | Description  |
| -------------- | ------------ |
| checkWallet | Returns information about number of connections wallet to network. |
| fillEmptyAddresses | Receives list of users who need to get input addresses, generate them and save to data base. |

### Incoming payments
| Method         | Description  |
| -------------- | ------------ |
| scanForNewTransactionsAndMoveToHot | Processes new block and scan it for new transactions and add them to database by `addHotInputTransaction`. |
| trackHotInputTransactions | Gets a list of pending transactions from database, checks the number of confirmations in wallet and updates in database. If number of transaction is equals to the number of required transactions, the `runHotTransactions` method is ran. |

### Withdraws
| Method         | Description  |
| -------------- | ------------ |
| checkAndSendSignedTransaction | Checks the database in order to search for new transactions to broadcast in network.If there are, it broadcasts them to the network and commits this fact in the database. |
| makeCommonPayments | This method asks database whether there are new withdrawals. If yes, this method prepares a common payment by running `makeCommonPaymentsTransaction` twice. First time, for making new signed transaction and calculation network fee based on transaction length per KB. Second time, for making new signed transaction with good value of network fee. Generated transacttion is stored in database for broadcasting by `checkAndSendSignedTransactions` method.
|trackHotOutputTransactions | Gets a list of outgoing transactions from database, checks the number of confirmations in wallet and updates in database. If number of transaction is equal to the number of required transactions, database removes the transaction from the list. |
